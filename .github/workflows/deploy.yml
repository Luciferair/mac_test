name: Upload IPA to App Store (Production)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  upload-production:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.event.head_commit && contains(github.event.head_commit.message, 'deploy')) }}
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create API Key file
      run: |
        echo "${{ secrets.APPSTORE_PRIVATE_KEY }}" > AuthKey.p8

    - name: Upload to App Store Connect
      run: |
        xcrun iTMSTransporter -m upload \
          -f files/toyutoyu.ipa \
          -k AuthKey.p8 \
          -i ${{ secrets.APPSTORE_KEY_ID }} \
          -issuer ${{ secrets.APPSTORE_ISSUER_ID }}

    - name: Clean up
      run: rm -f AuthKey.p8
