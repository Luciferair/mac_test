name: Upload IPA to App Store (Production)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  upload-production:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.event.head_commit && contains(github.event.head_commit.message, 'deploy')) }}
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create API Key file
      run: |
        mkdir -p ~/private_keys
        echo "${{ secrets.APPSTORE_PRIVATE_KEY }}" > ~/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8

    - name: Upload to App Store Connect
      run: |
        xcrun altool --upload-app \
          --type ios \
          --file files/toyutoyu.ipa \
          --apiKey ${{ secrets.APPSTORE_KEY_ID }} \
          --apiIssuer ${{ secrets.APPSTORE_ISSUER_ID }}

    - name: Clean up
      run: rm -f ~/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8
